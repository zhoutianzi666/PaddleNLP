## ğŸš£â€â™‚ï¸ ä½¿ç”¨ PaddleNLP åœ¨å¤©å“150ä¸‹è·‘é€š llama-13b æ¨¡å‹é¢„è®­ç»ƒ ğŸš£

å¤©å“150åŠ é€Ÿå¡ï¼ˆ[äº†è§£å¤©æ•°æ™ºèŠ¯](https://www.iluvatar.com/)ï¼‰æ˜¯åŸºäºå¤©æ•°æ™ºèŠ¯è‡ªç ”é€šç”¨ GPU çš„è®­æ¨ä¸€ä½“åŠ é€Ÿå¡ï¼Œå…·å¤‡å¹¿é€šç”¨æ€§ã€å¼ºçµæ´»æ€§ã€é«˜æ€§ä»·æ¯”çš„æ˜¾è‘—ä¼˜åŠ¿ï¼Œæ”¯æŒå¸‚åœºä¸»æµç”Ÿæ€ï¼Œå¯å¹¿æ³›åº”ç”¨äºä¸»æµå¤§æ¨¡å‹çš„é¢„è®­ç»ƒã€å¾®è°ƒä»¥åŠæ¨ç†ä»»åŠ¡ï¼Œä»¥åŠé€šç”¨è®¡ç®—ã€æ–°ç®—æ³•ç ”ç©¶ç­‰åœºæ™¯ï¼Œèµ‹èƒ½ AI æ™ºèƒ½ç¤¾ä¼šã€‚

PaddleNLP åœ¨å¤©å“150ä¸Šå¯¹ llama-13B æ¨¡å‹è¿›è¡Œäº†æ·±åº¦é€‚é…å’Œä¼˜åŒ–ï¼ŒåŸºæœ¬å®ç°äº†å¤©å“150å’Œ GPU è®­æ¨æ¥å£çš„ç»Ÿä¸€ï¼Œä½¿ç”¨æˆ·å¯ä»¥åœ¨å¤©å“150å’Œ GPU å¹³å°é—´è½»æ¾å®ç°åº”ç”¨è¿ç§»ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹ ğŸš€

### ï¼ˆ0ï¼‰åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦æœ‰å››å°æ’æœ‰å¤©å“150åŠ é€Ÿå¡çš„æœºå™¨ï¼Œå¯¹æ­¤æœºå™¨çš„ç³»ç»Ÿè¦æ±‚å¦‚ä¸‹ï¼š

| èŠ¯ç‰‡ç±»å‹ | é©±åŠ¨ç‰ˆæœ¬ | SDK ç‰ˆæœ¬      |
| -------- | --------- | --------------- |
| å¤©å“ 150 | â‰¥Â 4.1.0  | â‰¥Â 4.1.0 |

**æ³¨ï¼šå¦‚æœéœ€è¦éªŒè¯æ‚¨çš„æœºå™¨æ˜¯å¦æ’æœ‰å¤©å“150ï¼Œåªéœ€ç³»ç»Ÿç¯å¢ƒä¸‹è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œçœ‹æ˜¯å¦æœ‰è¾“å‡ºï¼š**

```bash
ixsmi

#è¾“å‡ºå¦‚ä¸‹

Timestamp    Fri Dec 20 11:14:29 2024
+-----------------------------------------------------------------------------+
|  IX-ML: 4.1.0       Driver Version: 4.1.0       CUDA Version: 10.2          |
|-------------------------------+----------------------+----------------------|
| GPU  Name                     | Bus-Id               | Clock-SM  Clock-Mem  |
| Fan  Temp  Perf  Pwr:Usage/Cap|      Memory-Usage    | GPU-Util  Compute M. |
|===============================+======================+======================|
| 0    Iluvatar BI-V150         | 00000000:13:00.0     | 1500MHz   1600MHz    |
| 0%   32C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 1    Iluvatar BI-V150         | 00000000:16:00.0     | 1500MHz   1600MHz    |
| 0%   30C   P0    93W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 2    Iluvatar BI-V150         | 00000000:1C:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 3    Iluvatar BI-V150         | 00000000:1F:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    94W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 4    Iluvatar BI-V150         | 00000000:27:00.0     | 1500MHz   1600MHz    |
| 0%   30C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 5    Iluvatar BI-V150         | 00000000:2A:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    98W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 6    Iluvatar BI-V150         | 00000000:34:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 7    Iluvatar BI-V150         | 00000000:37:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    95W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 8    Iluvatar BI-V150         | 00000000:3D:00.0     | 1500MHz   1600MHz    |
| 0%   32C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 9    Iluvatar BI-V150         | 00000000:40:00.0     | 1500MHz   1600MHz    |
| 0%   32C   P0    95W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 10   Iluvatar BI-V150         | 00000000:48:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 11   Iluvatar BI-V150         | 00000000:4B:00.0     | 1500MHz   1600MHz    |
| 0%   31C   P0    94W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 12   Iluvatar BI-V150         | 00000000:54:00.0     | 1500MHz   1600MHz    |
| 0%   30C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 13   Iluvatar BI-V150         | 00000000:57:00.0     | 1500MHz   1600MHz    |
| 0%   32C   P0    93W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 14   Iluvatar BI-V150         | 00000000:64:00.0     | 1500MHz   1600MHz    |
| 0%   30C   P0    N/A / N/A    | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+
| 15   Iluvatar BI-V150         | 00000000:67:00.0     | 1500MHz   1600MHz    |
| 0%   30C   P0    94W / 350W   | 116MiB / 32768MiB    | 0%        Default    |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU        PID      Process name                                Usage(MiB) |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
```

### ï¼ˆ1ï¼‰ç¯å¢ƒå‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨5~55min æ—¶é—´)
1. æ‹‰å–é•œåƒ
```bash
# è¯·è”ç³»å¤©æ•°æ™ºèŠ¯å®¢æˆ·æ”¯æŒ(services@iluvatar.com)è·å–SDKé•œåƒ

docker pull 10.150.9.98:80/sw_test/sw_home:4.1.0.20240528.110-x86_64-py3.10-bi150
```

2. å‚è€ƒå¦‚ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨

```bash
docker run -e USER=`id -u -n` -e USER_ID=`id -u` --name paddle-corex-dev -it --privileged --cap-add=ALL --pid=host --network=host -v /data1:/data1 --mount type=volume,dst=/home/`id -u -n`/.local bdkw:paddle-corex /bin/bash
```

3. å®‰è£… PaddlePaddle

â‘ å¦‚æœæ‚¨å·²ç»é€šè¿‡ Iluvatar CoreX è·å–äº† PaddlePaddle å®‰è£…åŒ…(services@iluvatar.com)ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¿›è¡Œå®‰è£…ï¼š

```bash
pip3 install paddlepaddle-2.5.2+corex*.whl
```
â‘¡æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡æºç è‡ªè¡Œç¼–è¯‘ PaddlePaddle å®‰è£…åŒ…ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»æ­£ç¡®å®‰è£… Iluvatar CoreX è½¯ä»¶æ ˆã€‚

```bash
# 1. è®¿é—® Paddle4CoreX githubä»“åº“cloneä»£ç å¹¶åˆ‡æ¢è‡³BDKW/2.5.2_corexåˆ†æ”¯.
git clone --recurse-submodules -b BDKW/2.5.2_corex https://github.com/PaddlePaddle/Paddle4CoreX.git
# 2. æ‰§è¡Œç¼–è¯‘è„šæœ¬
bash build_paddle.sh
# 3. ç­‰å¾…ç¼–è¯‘å®Œæˆåæ‰§è¡Œå®‰è£…è„šæœ¬
bash install_paddle.sh
```

4. å…‹éš† PaddleNLP ä»“åº“ä»£ç ï¼Œå¹¶å®‰è£…ä¾èµ–

```bash
# PaddleNLPæ˜¯åŸºäºpaddlepaddleã€é£æ¡¨ã€çš„è‡ªç„¶è¯­è¨€å¤„ç†å’Œå¤§è¯­è¨€æ¨¡å‹(LLM)å¼€å‘åº“ï¼Œå­˜æ”¾äº†åŸºäºã€é£æ¡¨ã€æ¡†æ¶å®ç°çš„å„ç§å¤§æ¨¡å‹ï¼Œllama-13Bæ¨¡å‹ä¹ŸåŒ…å«å…¶ä¸­ã€‚ä¸ºäº†ä¾¿äºæ‚¨æ›´å¥½åœ°ä½¿ç”¨PaddleNLPï¼Œæ‚¨éœ€è¦cloneæ•´ä¸ªä»“åº“ã€‚
git clone -b sci/benchmark_iluvatar https://github.com/tianyuzhou668/PaddleNLP.git
# ç¼–è¯‘è‡ªå®šä¹‰ç®—å­ï¼Œå¯é€‰
cd PaddleNLP
cd ./model_zoo/gpt-3/external_ops/ && python3 setup.py install && cd -
# å®‰è£…PaddleNLP
python3 -m pip install -r requirements.txt
python3 -m pip install -e .
```

### ï¼ˆ2ï¼‰æ•°æ®å‡†å¤‡ï¼š(è¿™å°†èŠ±è´¹æ‚¨2ï½5min æ—¶é—´)
ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è¿è¡Œæµ‹è¯•æœ¬æ¨¡å‹ï¼Œæä¾›äº†å¤„ç†å¥½çš„100k æ¡ doc çš„è®­ç»ƒæ ·æœ¬ï¼š
```bash
# llama æ¨¡å‹æ•°æ®ä¸‹è½½
cd ./llm
wget https://bj.bcebos.com/paddlenlp/models/transformers/llama/data/llama_openwebtext_100k.bin
wget https://bj.bcebos.com/paddlenlp/models/transformers/llama/data/llama_openwebtext_100k.idx
```
æ‚¨ä¹Ÿå¯ä»¥ä¸‹è½½å®Œæ•´çš„æ•°æ®é›†ï¼š
```bash
cd ./llm
wget https://paddlenlp.bj.bcebos.com/datasets/PDC_DATASETS/PRETRAIN/openwebtext2/llama/mmap/llama_mmap.bin
wget https://paddlenlp.bj.bcebos.com/datasets/PDC_DATASETS/PRETRAIN/openwebtext2/llama/mmap/llama_mmap.idx
```
å°†æ‰€æœ‰é¢„å¤„ç†å¾—åˆ°çš„æ–‡ä»¶ç»Ÿä¸€æ”¾å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œä»¥å¤‡è®­ç»ƒä½¿ç”¨ï¼š
```bash
mkdir data
mv llama_openwebtext_100k_ids.npy ./data
mv llama_openwebtext_100k_idx.npz ./data
```

### ï¼ˆ3ï¼‰é¢„è®­ç»ƒï¼š
æˆ‘ä»¬åœ¨æœ¬ç›®å½•ä¸­æä¾›äº†å¯¹åº”å››èŠ‚ç‚¹çš„é¢„è®­ç»ƒè„šæœ¬ï¼Œå¹¶å·²ç»æŒ‰ç…§32å¼  BI150èŠ¯ç‰‡çš„è®­ç»ƒèµ„æºä¼˜åŒ–äº†å¹¶è¡Œç­–ç•¥ç­‰é…ç½®ä¾›æ‚¨å‚è€ƒã€‚å¯åŠ¨é¢„è®­ç»ƒçš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š
```bash
# æ‚¨éœ€è¦åœ¨è„šæœ¬ä¸­å°†èŠ‚ç‚¹çš„ipåœ°å€æ›´æ¢ä¸ºæ‚¨å®é™…èŠ‚ç‚¹çš„ipåœ°å€
bash run_node4.sh
```
æˆ‘ä»¬é»˜è®¤ä¼šè®­ç»ƒ5000æ­¥ï¼Œå¾…5000æ­¥è®­ç»ƒå®Œæ¯•åï¼Œæ¨¡å‹ä¼šåš Evaluation å¹¶å¾—åˆ°æœ€ç»ˆçš„ checkpoint æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥åŸºäºè¯¥ checkpoint è¿›è¡Œå¾®è°ƒä»»åŠ¡æˆ–ç›´æ¥è¿›è¡Œæ¨ç†ä»»åŠ¡ã€‚
